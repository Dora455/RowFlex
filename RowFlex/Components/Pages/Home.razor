@page "/"
@using RowFlex.Models
@using RowFlex.Data
@inject DataBaseService DataBaseService

<PageTitle>Home</PageTitle>

<h1>Welcome to RowFlex!</h1>

<div class="row">
    <!-- News Section -->
    <div class="col-md-8">
        <h2>News</h2>
        @if (NewsList == null)
        {
            <p>Loading news...</p>
        }
        else if (!NewsList.Any())
        {
            <p>No news available.</p>
        }
        else
        {
            <ul class="list-group">
                @foreach (var news in NewsList)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h5>@news.Title</h5>
                            <p class="mb-0 text-muted">@news.Description</p>
                            <small><i>Published on: @news.PublishedDate.ToString("MMM dd, yyyy")</i></small>
                        </div>
                    </li>
                }
            </ul>
        }
    </div>

    <!-- Calendar Section -->
    <div class="col-md-4">
        <h2>Event Calendar</h2>
        @if (EventList == null)
        {
            <p>Loading events...</p>
        }
        else if (!EventList.Any())
        {
            <p>No events available.</p>
        }
        else
        {
            <div class="list-group">
                @foreach (var eventItem in EventList)
                {
                    <div class="list-group-item">
                        <strong>@eventItem.Title</strong>
                        <br />
                        <small>From: @eventItem.StartDate.ToString("MMM dd, yyyy hh:mm tt")</small><br />
                        <small>To: @eventItem.EndDate.ToString("MMM dd, yyyy hh:mm tt")</small>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<News> NewsList { get; set; }
    private List<Event> EventList { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Fetch the news and events from the database
        NewsList = await DataBaseService.GetAllNewsAsync();
        EventList = await DataBaseService.GetAllEventsAsync();

        // Filter out past events
        var currentDateTime = DateTime.UtcNow;
        EventList = EventList.Where(e => e.StartDate >= currentDateTime).ToList();

        // Fetch training plans and convert them to news items
        var trainingPlans = await DataBaseService.GetAllTrainingPlansAsync();
        foreach (var plan in trainingPlans)
        {
            if (plan.TrainingDate >= currentDateTime)
            {
                NewsList.Add(new News
                {
                    Title = "New Training Plan: " + plan.Training?.Title,
                    Description = "Scheduled Date: " + plan.TrainingDate.ToString("MMM dd, yyyy") + "\nDescription: " + plan.Training?.Description,
                    PublishedDate = plan.TrainingDate
                });
            }
        }

        // Sort news by PublishedDate in descending order
        NewsList = NewsList.OrderBy(n => n.PublishedDate).ToList();
    }
}